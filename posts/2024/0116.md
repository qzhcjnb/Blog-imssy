---
title: ä½¿ç”¨ Github Actions è‡ªåŠ¨éƒ¨ç½² Docker Image
tags: [Github, Actions, Docker, å‰ç«¯]
categories: [æŠ€æœ¯åˆ†äº«]
date: 2024-01-16 11:05:27
description: ä»¥å‰æ¯æ¬¡æ›´æ–°é¡¹ç›®æ—¶ï¼Œè¿˜å¾—å•ç‹¬å» DockerHub æ‰‹åŠ¨éƒ¨ç½²æ¨é€é•œåƒï¼Œå¤ªéº»çƒ¦äº†ã€‚å¶ç„¶å‘ç°èƒ½é€šè¿‡ Github Actions æ¥å®ç°è‡ªåŠ¨éƒ¨ç½²æ¨é€ï¼ŒåŒæ—¶è¿˜èƒ½æ¨é€åˆ° GitHub Container Registry ä¸­
articleGPT: è¿™ä¸ªé¡µé¢è®²è¿°äº†ä½¿ç”¨Dockerå’ŒGitHub Actionså®ç°è‡ªåŠ¨éƒ¨ç½²çš„å‡†å¤‡å·¥ä½œå’Œè®¾ç½®æµç¨‹ï¼ŒåŒ…æ‹¬åœ¨GitHubä»“åº“ä¸­åˆ›å»ºæœºå¯†å’Œå·¥ä½œæµæ–‡ä»¶ã€‚å®Œæˆè®¾ç½®åï¼Œå³å¯è‡ªåŠ¨éƒ¨ç½²æ–°ç‰ˆæœ¬ã€‚
---

## å‰æœŸå‡†å¤‡

åœ¨ä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²ä¹‹å‰ï¼Œç¡®ä¿ä½ å¯¹ Docker å’Œ GitHub Actions æœ‰ä¸€å®šçš„äº†è§£ã€‚

### Docker æ˜¯ä»€ä¹ˆ

[Docker](https://www.docker.com/) æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œå…è®¸å¼€å‘è€…å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–é¡¹æ‰“åŒ…åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸­çš„ä¸€è‡´æ€§è¿è¡Œã€‚

### GitHub Actions æ˜¯ä»€ä¹ˆ

[GitHub Actions](https://docs.github.com/zh/actions) æ˜¯ GitHub æä¾›çš„æŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²å·¥å…·ï¼Œå¯ç”¨äºè‡ªåŠ¨åŒ–è½¯ä»¶å¼€å‘å·¥ä½œæµç¨‹ã€‚

### æ³¨å†Œè´¦å·

{% note å¦‚æœä½ å·²æœ‰&nbsp;GitHub&nbsp;å’Œ&nbsp;DockerHub&nbsp;çš„è´¦å·ï¼Œä½ å¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ %}

åœ¨ [DockerHub](https://hub.docker.com/) æ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œæˆ–è€…ä½¿ç”¨ç°æœ‰çš„ `GitHub` è´¦å·è¿›è¡Œç™»å½•ã€‚æ³¨å†Œåï¼Œè¯·è®°å½•ä¸‹ä½ çš„ `username` å’Œ `password`ï¼Œè¿™å°†ç”¨äºåç»­ç¼–å†™ GitHub Actions å·¥ä½œæµã€‚

å¦å¤–ï¼Œé™¤äº† `DockerHub`ï¼Œ`GitHub` ä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„æœåŠ¡ï¼Œå«åš `GitHub Container Registry`ï¼Œç®€ç§° `GCR`ã€‚æœ¬æ–‡ä¹Ÿå°†ä»‹ç»å¦‚ä½•åŒæ—¶æ¨é€ `Docker Image` åˆ° `DockerHub` å’Œ `GCR`ã€‚

### å‡†å¤‡ä¿¡æ¯

ç°åœ¨ï¼Œä½ å·²ç»ä¸ºè‡ªåŠ¨åŒ–éƒ¨ç½²çš„ä¸‹ä¸€æ­¥åšå¥½äº†å……åˆ†çš„å‡†å¤‡ã€‚æ¥ä¸‹æ¥ï¼Œå°†æ·±å…¥ä»‹ç»å¦‚ä½•é…ç½® `GitHub Actions Workflow` æ–‡ä»¶ä»¥å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

## ä»“åº“æ“ä½œ

### æ–°å»ºæœºå¯†

åœ¨ä½ çš„ GitHub ä»“åº“ä¸­ï¼Œç‚¹å‡» `Settings`ï¼Œç„¶åç‚¹å‡»å·¦ä¾§å¯¼èˆªæ çš„ `Secrets and variables` ç±»åˆ«ä¸‹çš„ `Actions` é€‰é¡¹

![ä¸€ä¸ªå¡«å†™ç¤ºä¾‹](https://pic.efefee.cn/uploads/2024/01/29/65b6ff101b94c.webp)

ç„¶ååˆ†åˆ«æ–°å¢ä¸‹é¢çš„å†…å®¹

- `DOCKER_USERNAME`: ä½ çš„ DockerHub ç”¨æˆ·å
- `DOCKER_PASSWORD`: ä½ çš„ DockerHub å¯†ç 

![æ·»åŠ æˆåŠŸç¤ºä¾‹](https://pic.efefee.cn/uploads/2024/01/29/65b6ff101d2e5.webp)

### åˆ›å»ºå·¥ä½œæµæ–‡ä»¶

ç„¶ååœ¨ä»“åº“ä¸­æ–°å¢ä¸€ä¸ª `.github/workflows/docker.yml` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

```yml docker.yml
# å·¥ä½œæµåç§°
name: Publish Docker image
# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶ï¼Œè¿™é‡Œè¡¨ç¤ºå‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è§¦å‘
on:
  release:
    types: [published]
# å·¥ä½œæµç¨‹
jobs:
  push_to_registry:
    name: Push Docker image to multiple registries
    # å·¥ä½œæµè¿è¡Œçš„æœºå™¨ç¯å¢ƒ
    runs-on:
      ubuntu-latest
    # è®¾ç½®å·¥ä½œæµç¨‹çš„æƒé™
    permissions:
      packages: write
      contents: read
    # æ­¥éª¤
    steps:
      # æ£€å‡ºä»“åº“
      - name: Check out the repo
        uses: actions/checkout@v4
      # ç™»å½•åˆ° Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      # ç™»å½•åˆ° GitHub Container Registry
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # GitHub Actions ä¼šé»˜è®¤æä¾›ä¸€ä¸ªç‰¹æ®Šçš„ Token (GITHUB_TOKEN)ï¼Œç”¨äºæ‰§è¡Œå·¥ä½œæµç¨‹ä¸­çš„æ“ä½œï¼ŒåŒ…æ‹¬ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
          password: ${{ secrets.GITHUB_TOKEN }}
      # æå– Docker çš„å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€æ ‡ç­¾ï¼‰
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            imsyy/splayer
            ghcr.io/${{ github.repository }}
      # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Docker ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œè¡¨ç¤º Dockerfile æ‰€åœ¨çš„ç›®å½•ä¸ºå½“å‰ç›®å½•
          file: ./Dockerfile # Dockerfile æ–‡ä»¶çš„è·¯å¾„
          push: true # è®¾ç½®ä¸º true è¡¨ç¤ºæ„å»ºå®Œæˆåæ¨é€ Docker é•œåƒåˆ°é•œåƒä»“åº“
          tags: ${{ steps.meta.outputs.tags }} # ä½¿ç”¨ metadata-action è¾“å‡ºçš„æ ‡ç­¾ä½œä¸º Docker é•œåƒçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }} # ä½¿ç”¨ metadata-action è¾“å‡ºçš„æ ‡ç­¾ä½œä¸º Docker é•œåƒçš„æ ‡ç­¾
```

## å®Œæˆ

å¤§åŠŸå‘Šæˆï¼è¯•ç€å»å‘å¸ƒä¸€ä¸‹æ–°ç‰ˆæœ¬è¯•è¯•å§ ğŸ‰
